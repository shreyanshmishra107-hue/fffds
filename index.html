<!DOCTYPE html>
<html lang="en">
<head>
  <title>Live Stream Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <meta name="referrer" content="no-referrer"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.6.12/dist/plyr.css"/>
  <style>
    body {
      background-color: #000000;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    html, body {
      height: 100%;
    }
    video {
      width: 100%;
      height: 100%;
      max-width: 100%;
    }
    .plyr {
      height: 100%;
    }
  </style>
</head>
<body>
  <video id="player" autoplay controls crossorigin playsinline></video>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.1.4/dist/hls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.6.12/dist/plyr.min.js"></script>
  <script>
  (function() {
    // Configuration
    const PROXY_BASE = "https://allinonereborn.online/fcww/live222.php?url=";
    const JSON_URL = "https://raw.githubusercontent.com/Jitendra-unatti/fancode/refs/heads/main/data/fancode.json";

    // DOM elements
    const loadingEl = document.getElementById('loading');
    const loadingIdEl = document.getElementById('loading-id');
    const errorEl = document.getElementById('error');
    const video = document.getElementById('player');

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");
    const lang = urlParams.get("lang")  'english';

    // Show loading with ID
    loadingIdEl.textContent = id  'unknown';

    if (!id) {
      showError("No ID provided. Use ?id=136037 in the URL");
      return;
    }

    // Helper to show error
    function showError(msg) {
      loadingEl.style.display = 'none';
      errorEl.style.display = 'block';
      errorEl.textContent = msg;
      console.error(msg);
    }

    // Helper to show video
    function showVideo() {
      loadingEl.style.display = 'none';
      video.style.display = 'block';
    }

    // Extract quality URLs from auto_streams
    function extractQualityUrls(autoString) {
      if (!autoString  typeof autoString !== 'string') {
        console.log("No auto string provided");
        return [];
      }
      
      const lines = autoString.split('\n');
      const qualities = [];
      let currentInfo = {};
      
      for (let line of lines) {
        line = line.trim();
        
        if (line.startsWith('#EXT-X-STREAM-INF:')) {
          // Parse stream info
          const resolutionMatch = line.match(/RESOLUTION=(\d+x\d+)/);
          const bandwidthMatch = line.match(/BANDWIDTH=(\d+)/);
          
          currentInfo = {
            resolution: resolutionMatch ? resolutionMatch[1] : null,
            bandwidth: bandwidthMatch ? parseInt(bandwidthMatch[1]) : null
          };
        } 
        else if (line && !line.startsWith('#')) {
          // This is a URL line
          const url = line;
          
          // Determine quality from resolution or URL
          let height = 360; // default
          
          if (currentInfo.resolution) {
            const heightMatch = currentInfo.resolution.split('x')[1];
            height = parseInt(heightMatch)  360;
          } else {
            // Try to extract from URL
            if (url.includes('1080p')) height = 1080;
            else if (url.includes('720p')) height = 720;
            else if (url.includes('540p')) height = 540;
            else if (url.includes('480p')) height = 480;
            else if (url.includes('360p')) height = 360;
            else if (url.includes('240p')) height = 240;
          }
          
          qualities.push({
            height: height,
            resolution: currentInfo.resolution  height + 'p',
            bandwidth: currentInfo.bandwidth  (height * 200000),
            url: url
          });
          
          currentInfo = {}; // reset
        }
      }
      
      // Remove duplicates and sort by height
      const unique = Array.from(new Map(qualities.map(q => [q.url, q])).values());
      return unique.sort((a, b) => b.height - a.height);
    }
    const player = new Plyr(video, {
              controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
              quality: {
                default: levels.includes(1080) ? 1080 : (levels[0] || 360),
                options: levels,
                forced: true,
                onChange: (quality) => {
                  const levelIndex = hls.levels.findIndex(level => level.height === quality);
                  if (levelIndex !== -1) {
                    hls.currentLevel = levelIndex;
                  }
                }
              }
            });

            // Auto fullscreen orientation lock
            document.addEventListener('fullscreenchange', () => {
              if (document.fullscreenElement && screen.orientation?.lock) {
                screen.orientation.lock('landscape').catch(() => {});
              }
            });

            window.player = player;
          });

          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error("HLS error:", data);
            if (data.fatal) {
              switch(data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  hls.recoverMediaError();
                  break;
                default:
                  showError("Fatal playback error");
                  break;
              }
            }
          });

        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          // Safari fallback
          video.src = blobUrl;
          new Plyr(video);
        } else {
          showError("HLS is not supported in this browser");
        }

      } catch (err) {
        console.error("Initialization error:", err);
        showError("Error loading stream: " + err.message);
      }
    }

    // Start the player
    initPlayer();

    // Join prompt after a delay
    setTimeout(() => {
      if (window.confirm("Join @matcheslinks for more live links?")) {
        window.open("https://t.me/+e3-eAje291cxNGNl", "_blank");
      }
    }, 5000);

  })();
  </script>
</body>
</html>
